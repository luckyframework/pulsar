<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Crystal Docs 1.6.2">
<meta name="crystal_docs.project_version" content="main">
<meta name="crystal_docs.project_name" content="pulsar">



<link href="css/style.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="js/doc.js"></script>

  <meta name="repository-name" content="pulsar">
  <title>pulsar main</title>
  <script type="text/javascript">
  CrystalDocs.base_path = "";
  </script>
</head>
<body>

<svg class="hidden">
  <symbol id="octicon-link" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path>
  </symbol>
</svg>
<div class="sidebar">
  <div class="sidebar-header">
    <div class="search-box">
      <input type="search" class="search-input" placeholder="Search..." spellcheck="false" aria-label="Search">
    </div>

    <div class="project-summary">
      <h1 class="project-name">
        <a href="index.html">
          pulsar
        </a>
      </h1>

      <span class="project-version">
        main
      </span>
    </div>
  </div>

  <div class="search-results hidden">
    <ul class="search-list"></ul>
  </div>

  <div class="types-list">
    <ul>
  
  <li class="parent " data-id="pulsar/Pulsar" data-name="pulsar">
      <a href="Pulsar.html">Pulsar</a>
      
        <ul>
  
  <li class=" " data-id="pulsar/Pulsar/BaseEvent" data-name="pulsar::baseevent">
      <a href="Pulsar/BaseEvent.html">BaseEvent</a>
      
    </li>
  
  <li class=" " data-id="pulsar/Pulsar/Event" data-name="pulsar::event">
      <a href="Pulsar/Event.html">Event</a>
      
    </li>
  
  <li class=" " data-id="pulsar/Pulsar/TimedEvent" data-name="pulsar::timedevent">
      <a href="Pulsar/TimedEvent.html">TimedEvent</a>
      
    </li>
  
</ul>

      
    </li>
  
</ul>

  </div>
</div>


<div class="main-content">
<h1><a id="pulsar" class="anchor" href="#pulsar">  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Pulsar</h1>
<p><a href="https://luckyframework.github.io/pulsar"><img src="https://img.shields.io/website?down_color=red&amp;down_message=Offline&amp;label=API%20Documentation&amp;up_message=Online&amp;url=https://luckyframework.github.io/pulsar/" alt="API Documentation Website" /></a></p>
<p>Pulsar is a simple Crystal library for publishing and subscribing to events.
It also has timing information for metrics. So what does that mean in
practice?</p>
<p>You can define an event and any number of subscribers can subscribe to the
event and do whatever they need with it.</p>
<p>For example, in Lucky, we use Pulsar to create events for things like
requests being processed, queries being made, before and after pipes running.
Then we subscribe to these events to write to the logs. We also use this
internally to log debugging information in an upcoming UI called Breeze that
let's users debug development information.</p>
<h2><a id="installation" class="anchor" href="#installation">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Installation</h2>
<ol>
<li>
<p>Add the dependency to your <code>shard.yml</code>:</p>
<pre><code class="language-yaml">dependencies:
  pulsar:
    github: luckyframework/pulsar</code></pre>
</li>
<li>
<p>Run <code>shards install</code></p>
</li>
</ol>
<h2><a id="how-to-use-pulsar" class="anchor" href="#how-to-use-pulsar">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>How to use Pulsar</h2>
<p>Let's say we're writing a library to charge a credit card and we may want to let
people run code whenever a charge is made. Here's how you can do that with Pulsar.</p>
<h3><a id="create-and-publish-an-event" class="anchor" href="#create-and-publish-an-event">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Create and publish an event</h3>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">PaymentProcessor</span><span class="t">::</span><span class="t">ChargeCardEvent</span> <span class="o">&lt;</span> <span class="t">Pulsar</span><span class="t">::</span><span class="t">Event</span>
  <span class="k">def</span> <span class="m">initialize</span>(@amount : <span class="t">Int32</span>)
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="t">PaymentProcessor</span>
  <span class="k">def</span> <span class="m">charge_card</span>(amount : <span class="t">Int32</span>)
    <span class="c"># Run code to charge the card...</span>

    <span class="c"># Then fire an event</span>
    <span class="t">PaymentProcessor</span><span class="t">::</span><span class="t">ChargeCardEvent</span>.publish(amount)
  <span class="k">end</span>
<span class="k">end</span></code></pre>
<h3><a id="subscribe-to-it-and-do-whatever-you-want-with-it" class="anchor" href="#subscribe-to-it-and-do-whatever-you-want-with-it">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Subscribe to it and do whatever you want with it</h3>
<p>Now you can subscribe to the event and do whatever you want with it. For example,
you might log that a charge was made, or you might send an email to the sales team.</p>
<pre><code class="language-crystal"><span class="t">PaymentProcessor</span><span class="t">::</span><span class="t">ChargeCardEvent</span>.subscribe <span class="k">do</span> <span class="o">|</span>event<span class="o">|</span>
  puts <span class="s">&quot;Charged: </span><span class="i">#{</span>event.amount<span class="i">}</span><span class="s"> at </span><span class="i">#{</span>event.started_at<span class="i">}</span><span class="s">&quot;</span>
<span class="k">end</span></code></pre>
<h3><a id="recording-timing-information" class="anchor" href="#recording-timing-information">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Recording timing information</h3>
<p>You can also time how long it takes to run an event by inheriting from
<code><a href="Pulsar/TimedEvent.html">Pulsar::TimedEvent</a></code>. You define them in the same way, but when you subscribe
you must also accept a second argument:</p>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span> <span class="o">&lt;</span> <span class="t">Pulsar</span><span class="t">::</span><span class="t">TimedEvent</span>
<span class="k">end</span>

<span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span>.subscribe <span class="k">do</span> <span class="o">|</span>event, duration<span class="o">|</span>
  <span class="c"># Do something with the event and duration</span>
<span class="k">end</span>

<span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span>.publish <span class="k">do</span>
  <span class="c"># Run a query, run some other code, etc.</span>
<span class="k">end</span></code></pre>
<h3><a id="add-more-information-to-the-event" class="anchor" href="#add-more-information-to-the-event">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Add more information to the event</h3>
<p>To add more information to the event you can use <code>initialize</code> like you would
with any other Crystal class.</p>
<p>For example, we can record the database query in the event from above</p>
<pre><code class="language-crystal"><span class="k">class</span> <span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span> <span class="o">&lt;</span> <span class="t">Pulsar</span><span class="t">::</span><span class="t">TimedEvent</span>
  getter <span class="n">:query</span>

  <span class="k">def</span> <span class="m">initialize</span>(@query : <span class="t">String</span>)
  <span class="k">end</span>
<span class="k">end</span>

<span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span>.subscribe <span class="k">do</span> <span class="o">|</span>event, duration<span class="o">|</span>
  puts event.query
<span class="k">end</span>

<span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span>.publish(query: <span class="s">&quot;SELECT * FROM users&quot;</span>) <span class="k">do</span>
  <span class="c"># Run a query, run some other code, etc.</span>
<span class="k">end</span></code></pre>
<h2><a id="testing-pulsar-events" class="anchor" href="#testing-pulsar-events">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Testing Pulsar events</h2>
<p>If you want to test that events are published you can use Pulsar's built-in test mode.</p>
<pre><code class="language-crystal"><span class="c"># Typically in spec/spec_helper.cr</span>

<span class="c"># Must come *after* `require &quot;spec&quot;`</span>
<span class="t">Pulsar</span>.enable_test_mode!</code></pre>
<p>This will enable an in-memory log for published events and will set up a hook to
clear the events before each spec runs.</p>
<p>You can access events using <code>{MyEventClass}.logged_events</code>.</p>
<pre><code class="language-crystal"># Create an event
class QueryEvent &lt; Pulsar::TimedEvent
  def initialize(@query : String)
  end
end

def run_my_query(query)
  # Publish the event
  QueryEvent.publish(query: query) do
    # Run the query somehow
  end
end

it &quot;publishes an event when a SQL query is executed&quot; do
  run_my_query &quot;SELECT * FROM users

  the_published_event = QueryEvent.logged_events.first
  the_published_event.query.should eq(&quot;SELECT * FROM users&quot;)
end</code></pre>
<h2><a id="pulsar.elapsed-text" class="anchor" href="#pulsar.elapsed-text">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a><code>Pulsar.elapsed_text</code></h2>
<p><code>Pulsar.elapsed_text</code> will return the time taken (<code>Time::Span</code>) as a human readable String.</p>
<pre><code class="language-crystal"><span class="t">Database</span><span class="t">::</span><span class="t">QueryEvent</span>.subscribe <span class="k">do</span> <span class="o">|</span>event, duration<span class="o">|</span>
  puts <span class="t">Pulsar</span>.elaspted_text(duration) <span class="c"># &quot;2.3ms&quot;</span>
<span class="k">end</span></code></pre>
<p>This method can be used with any <code>Time::Span</code>.</p>
<h2><a id="performance-gotchas" class="anchor" href="#performance-gotchas">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Performance gotchas</h2>
<p>Subscribers are notified synchronously in the same Fiber as the publisher.
This means that if you have a subscriber that takes a long time to run, it
will block anything else from running.</p>
<p>If you are doing some logging it is probably fine, but if you are doing
something more time-intensive or failure prone like making an HTTP request or
saving to the database you should pay special attention.</p>
<h3><a id="example-of-a-problematic-subscriber" class="anchor" href="#example-of-a-problematic-subscriber">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Example of a problematic subscriber</h3>
<pre><code class="language-crystal"><span class="t">MyEvent</span>.subscribe <span class="k">do</span> <span class="o">|</span>event<span class="o">|</span>
  sleep(<span class="n">5</span>)
<span class="k">end</span>

<span class="t">MyEvent</span>.publish

puts <span class="s">&quot;I just took 5 seconds to print!&quot;</span></code></pre>
<p>Oops. To get around this you can spawn a new fiber:</p>
<pre><code class="language-crystal"><span class="t">MyEvent</span>.subscribe <span class="k">do</span> <span class="o">|</span>event<span class="o">|</span>
  <span class="c"># Now the `sleep` will run in a new Fiber and will not block this one</span>
  spawn <span class="k">do</span>
    sleep(<span class="n">5</span>)
  <span class="k">end</span>
<span class="k">end</span>

<span class="t">MyEvent</span>.publish

puts <span class="s">&quot;This will print right away!&quot;</span></code></pre>
<h3><a id="potential-solutions" class="anchor" href="#potential-solutions">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Potential solutions</h3>
<p>As described above you could run long running code in a new Fiber with <code>spawn</code>.
You could also use a background job library like https://github.com/robacarp/mosquito.</p>
<p>Be aware that running things in a Fiber will lose the current Fiber's context. This is
important for logging since <code>Log.context</code> only works for the current Fiber.
So if you plan to log using the built-in Logger, you likely <em>do not</em> want to
spawn a new fiber. It is fast enough to just log like normal.</p>
<h2><a id="contributing" class="anchor" href="#contributing">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributing</h2>
<ol>
<li>Fork it (<a href="https://github.com/luckyframework/pulsar/fork">https://github.com/luckyframework/pulsar/fork</a>)</li>
<li>Create your feature branch (<code>git checkout -b my-new-feature</code>)</li>
<li>Commit your changes (<code>git commit -am 'Add some feature'</code>)</li>
<li>Push to the branch (<code>git push origin my-new-feature</code>)</li>
<li>Create a new Pull Request</li>
</ol>
<h2><a id="contributors" class="anchor" href="#contributors">
  <svg class="octicon-link" aria-hidden="true">
    <use href="#octicon-link"/>
  </svg>
</a>Contributors</h2>
<ul>
<li><a href="https://github.com/paulcsmith">paulcsmith</a> - creator and maintainer</li>
</ul>
</div>
</body>
</html>
